name: Go Multi-Platform Build

on:
    push:
        branches: ["master"]
    pull_request:
        branches: ["master"]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25" # 升级为1.25版本

            - name: Test
              run: go test -v ./...

    build:
        needs: test
        runs-on: ubuntu-latest
        strategy:
            matrix:
                goos: [linux, windows, darwin]
                goarch: [amd64, arm64]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25" # 升级为1.25版本

            - name: Create output directory
              run: mkdir -p dist

            - name: Build for ${{ matrix.goos }}-${{ matrix.goarch }}
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
                  CGO_ENABLED: 0
              run: |
                  if [ "${{ matrix.goos }}" = "windows" ]; then
                    output="dist/myapp-${{ matrix.goos }}-${{ matrix.goarch }}.exe"
                  else
                    output="dist/myapp-${{ matrix.goos }}-${{ matrix.goarch }}"
                  fi
                  go build -v -o "$output" ./...

            - name: Upload build artifact
              uses: actions/upload-artifact@v4 # 升级为v4版本（避免弃用）
              with:
                  name: myapp-${{ matrix.goos }}-${{ matrix.goarch }}
                  path: dist/
                  retention-days: 5 # 可选：设置产物保留天数（v4支持的新参数，按需调整）
