name: Go Multi-Platform Build

on:
    push:
        branches: ["master"]
    pull_request:
        branches: ["master"]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25"

            - name: Test
              run: go test -v ./...

    build:
        needs: test
        runs-on: ubuntu-latest
        strategy:
            matrix:
                goos: [linux, windows, darwin]
                goarch: [386, amd64, arm64]
                exclude:
                    - goos: darwin
                      goarch: 386 # macOS不支持32位

        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25"

            - name: Create output directory
              run: mkdir -p dist

            - name: Build for ${{ matrix.goos }}-${{ matrix.goarch }}
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
                  CGO_ENABLED: 0
              run: |
                  if [ "${{ matrix.goos }}" = "windows" ]; then
                    output="dist/XMU-Service-${{ matrix.goos }}-${{ matrix.goarch }}.exe"
                  else
                    output="dist/XMU-Service-${{ matrix.goos }}-${{ matrix.goarch }}"
                  fi
                  echo "Building to $output"
                  # 只构建主程序（假设 main.go 在仓库根目录）
                  go build -v -o "$output" .

                  # 保存输出路径到环境变量（供 upload-artifact 使用）
                  echo "output=$output" >> $GITHUB_ENV

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: XMU-Service-${{ matrix.goos }}-${{ matrix.goarch }}
                  path: ${{ env.output }}
                  retention-days: 5
