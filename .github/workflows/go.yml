name: Go Multi-Platform Build

on:
    push:
        branches: ["master"]
    pull_request:
        branches: ["master"]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25"

            - name: Test
              run: go test -v ./... # 测试所有包，没问题

    build:
        needs: test
        runs-on: ubuntu-latest
        strategy:
            matrix:
                goos: [linux, windows, darwin]
                goarch: [386, amd64, arm64] # 包含Intel x86（386）和x86_64（amd64）
                exclude:
                    - goos: darwin
                      goarch: 386 # macOS不支持32位

        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25"

            - name: Create output directory
              run: mkdir -p dist

            - name: Build for ${{ matrix.goos }}-${{ matrix.goarch }}
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
                  CGO_ENABLED: 0
              run: |
                  # 和本地编译逻辑一致：根目录生成对应平台的可执行文件
                  if [ "${{ matrix.goos }}" = "windows" ]; then
                    output="dist/myapp-${{ matrix.goos }}-${{ matrix.goarch }}.exe"
                  else
                    output="dist/myapp-${{ matrix.goos }}-${{ matrix.goarch }}"
                  fi
                  # 关键：用.表示根目录的main包，和你本地`go build`命令一致
                  go build -v -o "$output" .

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: myapp-${{ matrix.goos }}-${{ matrix.goarch }}
                  path: ${{ env.output }} # 直接上传生成的单个文件，更精准
                  retention-days: 5
